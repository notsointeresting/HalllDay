{% extends "base.html" %}
{% block content %}
<section class="admin">
  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 32px;">
    <h2>Admin Dashboard</h2>
    <a href="{{ url_for('admin_logout') }}"
       style="color: var(--md-sys-color-primary); font: var(--md-sys-typescale-label-large); text-decoration: none;">
       Logout
    </a>
  </div>

  <div style="display: flex; gap: 16px; margin-bottom: 32px; flex-wrap: wrap;">
    <div class="chip" style="background: var(--md-sys-color-secondary-container); color: var(--md-sys-color-on-secondary-container);">
      Open Sessions: <strong>{{ open_count }}</strong>
    </div>
    <div class="chip" style="background: var(--md-sys-color-surface-variant); color: var(--md-sys-color-on-surface-variant);">
      Total Sessions: <strong>{{ total }}</strong>
    </div>
  </div>

  <!-- Roster Management -->
  <h3>Roster Management</h3>
  <div class="card-surface">
    <h4 style="margin: 0 0 16px 0; display: flex; align-items: center; gap: 8px;">
      <span class="material-symbols-rounded">lock</span>
      FERPA-Compliant Upload
    </h4>
    <p>Student data is encrypted and stored securely.</p>
    
    <form id="sessionRosterForm" style="display: flex; gap: 12px; align-items: center; flex-wrap: wrap; margin-bottom: 16px;">
      <input type="file" id="sessionFileInput" name="file" accept=".csv" style="padding: 8px;">
      <button type="submit" class="primary-btn">Upload CSV</button>
      <button type="button" id="sessionUploadBtn">Alternative Upload</button>
    </form>
    
    <div id="sessionRosterResult"></div>

    <div style="margin-top: 16px; display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
      <div style="padding: 12px; background: var(--md-sys-color-background); border-radius: 8px;">
        <div style="font: var(--md-sys-typescale-headline-small); color: var(--md-sys-color-primary);">{{ db_roster_count }}</div>
        <div style="font: var(--md-sys-typescale-body-small);">Database Roster (Encrypted)</div>
      </div>
      <div style="padding: 12px; background: var(--md-sys-color-background); border-radius: 8px;">
        <div style="font: var(--md-sys-typescale-headline-small); color: var(--md-sys-color-secondary);">{{ memory_roster_count }}</div>
        <div style="font: var(--md-sys-typescale-body-small);">Display Cache</div>
      </div>
    </div>

    <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--md-sys-color-outline);">
      <button type="button" id="clearSessionBtn" style="color: var(--md-sys-color-error); border-color: var(--md-sys-color-error);">
        Clear All Roster Data
      </button>
      <div id="sessionDebugResult" style="font-size: 12px; margin-top: 8px;"></div>
    </div>
  </div>

  <!-- Settings -->
  <h3>Settings</h3>
  <div class="card-surface">
    <div style="margin-bottom: 16px;">
      {% if sheets_status == 'ok' %}
        <span class="chip" style="background: #e6ffed; color: #1f7a1f;">Sheets: OK</span>
      {% elif sheets_status == 'degraded' %}
        <span class="chip" style="background: #fffbea; color: #975a16;">Sheets: Degraded</span>
      {% else %}
        <span class="chip" style="background: #edf2f7; color: #4a5568;">Sheets: Off</span>
      {% endif %}
      {% if sheets_link %}<a href="{{ sheets_link }}" target="_blank" style="margin-left: 8px; font-size: 14px;">Open Logs</a>{% endif %}
    </div>

    <form id="settingsForm" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
      <div>
        <label style="display: block; margin-bottom: 4px; font: var(--md-sys-typescale-label-small);">Room Name</label>
        <input name="room_name" value="{{ settings.room_name }}" style="width: 100%;">
      </div>
      <div>
        <label style="display: block; margin-bottom: 4px; font: var(--md-sys-typescale-label-small);">Capacity</label>
        <input type="number" min="1" name="capacity" value="{{ settings.capacity }}" style="width: 100%;">
      </div>
      <div>
        <label style="display: block; margin-bottom: 4px; font: var(--md-sys-typescale-label-small);">Overdue (min)</label>
        <input type="number" min="1" name="overdue_minutes" value="{{ settings.overdue_minutes }}" style="width: 100%;">
      </div>
      <div style="display: flex; align-items: flex-end;">
        <button type="submit" class="primary-btn">Save Settings</button>
      </div>
    </form>
    <div id="settingsResult" style="margin-top: 8px; font-size: 14px;"></div>
  </div>

  <!-- Stats -->
  <h3>Weekly Insights</h3>
  <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap:16px;">
    <div class="card-surface">
      <h4 style="margin-top:0;">Top Users</h4>
      <canvas id="chartTopUsage" height="160"></canvas>
    </div>
    <div class="card-surface">
      <h4 style="margin-top:0;">Most Overdue</h4>
      <canvas id="chartTopOverdue" height="160"></canvas>
    </div>
    <div class="card-surface">
      <h4 style="margin-top:0;">Overdue Rate %</h4>
      <canvas id="chartTopOverdueRate" height="160"></canvas>
    </div>
  </div>

  <!-- Auto Ban -->
  <h3>Auto-Ban</h3>
  <div class="card-surface" style="border-left: 4px solid var(--md-sys-color-error);">
    {% if not settings.get('auto_ban_overdue') and settings.get('auto_ban_overdue') is none %}
    <div style="background: var(--color-yellow-container); color: var(--color-yellow-on-container); padding: 12px; margin-bottom: 16px; border-radius: 8px;">
      <strong>‚ö†Ô∏è Setup Required:</strong> Run database migration below.
    </div>
    {% endif %}

    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
      <label class="switch-label" style="display: flex; align-items: center; gap: 8px; font-weight: 500; cursor: pointer;">
        <input type="checkbox" id="autoBanToggle" {% if settings.get('auto_ban_overdue') %}checked{% endif %} style="width: 20px; height: 20px;">
        <span id="autoBanToggleLabel">
          {% if settings.get('auto_ban_overdue') %}Auto-Ban Enabled{% else %}Auto-Ban Disabled{% endif %}
        </span>
      </label>
    </div>
    
    <p style="font-size: 13px; margin-bottom: 16px;">Checks every second. Overdue threshold: <strong>{{ settings.overdue_minutes }} min</strong>.</p>
    <div id="autoBanToggleResult"></div>

    <h4 style="color: var(--md-sys-color-error); margin: 24px 0 12px 0;">Currently Overdue</h4>
    <div style="display: flex; gap: 12px; margin-bottom: 12px;">
      <button id="loadOverdueBtn" style="background: var(--color-yellow-primary); color: white;">Check Overdue</button>
      <button id="manualBanOverdueBtn" style="background: var(--md-sys-color-error); color: white;" disabled>Ban All Overdue</button>
    </div>
    <div id="overdueListContainer" style="display: none;">
      <div id="overdueList" style="max-height: 200px; overflow-y: auto; background: var(--md-sys-color-background); padding: 8px; border-radius: 8px;"></div>
    </div>
    <div id="overdueResult" style="margin-top: 8px;"></div>
  </div>

  <!-- Restroom Bans -->
  <h3>Banned Students</h3>
  <div class="card-surface" style="border-left: 4px solid var(--color-yellow-primary);">
    <button id="loadStudentsBtn" class="primary-btn" style="margin-bottom: 16px;">Load Student List</button>
    
    <div id="studentListContainer" style="display: none;">
      <input type="text" id="studentSearchBox" placeholder="Search students..." style="width: 100%; margin-bottom: 12px;">
      <div style="max-height: 300px; overflow-y: auto; border: 1px solid var(--md-sys-color-outline); border-radius: 8px;">
        <div id="studentList" style="padding: 8px;"></div>
      </div>
      <div id="banResult" style="margin-top: 8px;"></div>
    </div>
  </div>

  <!-- Controls -->
  <h3>System Controls</h3>
  <div class="card-surface">
    <div style="margin-bottom: 24px;">
      <h4 style="margin-top: 0;">Kiosk Status</h4>
      {% if settings.kiosk_suspended %}
      <div style="display: flex; gap: 12px; align-items: center;">
        <button id="resumeKiosk" style="background: var(--md-sys-color-primary); color: white;">Resume Kiosk</button>
        <span style="color: var(--md-sys-color-error); font-weight: bold;">SUSPENDED</span>
      </div>
      {% else %}
      <div style="display: flex; gap: 12px; align-items: center;">
        <button id="suspendKiosk" style="background: var(--md-sys-color-error); color: white;">Suspend Kiosk</button>
        <span style="color: var(--md-sys-color-primary);">Active</span>
      </div>
      {% endif %}
    </div>

    <div style="margin-bottom: 24px;">
      <h4 style="margin-top: 0;">Database Maintenance</h4>
      <button id="runMigration" style="background: var(--md-sys-color-secondary); color: white;">Run Migrations</button>
      <span id="migrationResult" style="margin-left: 8px;"></span>
    </div>

    <div style="background: var(--md-sys-color-error-container); padding: 16px; border-radius: 12px;">
      <h4 style="margin-top: 0; color: var(--md-sys-color-on-error-container);">Danger Zone</h4>
      <p style="color: var(--md-sys-color-on-error-container); font-size: 13px;">Permanently delete all session history.</p>
      <button id="resetDbBtn" style="background: var(--md-sys-color-error); color: white;">Delete History</button>
      <span id="resetDbResult" style="margin-left: 8px; color: var(--md-sys-color-on-error-container);"></span>
    </div>
  </div>

  <div style="margin-top: 32px; display: flex; gap: 16px;">
    <button id="override">Force End Current Session</button>
    <a href="{{ url_for('export_csv') }}" class="primary-btn" style="text-decoration: none; background: var(--md-sys-color-secondary);">Download CSV</a>
  </div>
</section>

<!-- Scripts -->
<script>
  document.getElementById('override').onclick = async () => {
    const r = await fetch('/api/override_end', { method: 'POST' });
    const j = await r.json();
    alert(j.ok ? 'Ended.' : (j.message || 'Error'));
  };

  // Auto-Ban Toggle
  document.getElementById('autoBanToggle').onchange = async function () {
    const checkbox = this;
    const isEnabled = checkbox.checked;
    const label = document.getElementById('autoBanToggleLabel');
    const resultDiv = document.getElementById('autoBanToggleResult');

    label.textContent = isEnabled ? 'Auto-Ban Enabled' : 'Auto-Ban Disabled';
    resultDiv.textContent = 'Saving...';

    try {
      const r = await fetch('/api/settings', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ auto_ban_overdue: isEnabled })
      });
      const j = await r.json();

      if (j.ok) {
        resultDiv.textContent = isEnabled ? 'Saved: Active' : 'Saved: Disabled';
        setTimeout(() => { resultDiv.textContent = ''; }, 3000);
      } else {
        checkbox.checked = !isEnabled;
        label.textContent = !isEnabled ? 'Auto-Ban Enabled' : 'Auto-Ban Disabled';
        resultDiv.textContent = `Failed: ${j.message}`;
      }
    } catch (error) {
      checkbox.checked = !isEnabled;
      resultDiv.textContent = `Error: ${error.message}`;
    }
  };

  // Overdue
  let overdueStudents = [];
  document.getElementById('loadOverdueBtn').onclick = async () => {
    const btn = document.getElementById('loadOverdueBtn');
    const container = document.getElementById('overdueListContainer');
    const resultDiv = document.getElementById('overdueResult');
    const manualBanBtn = document.getElementById('manualBanOverdueBtn');

    btn.disabled = true;
    btn.textContent = 'Checking...';
    try {
      const r = await fetch('/api/overdue_students');
      const j = await r.json();
      if (j.ok) {
        overdueStudents = j.students || [];
        renderOverdueList();
        container.style.display = 'block';
        btn.textContent = `Found ${j.count}`;
        resultDiv.textContent = j.count > 0 ? `${j.count} overdue.` : 'None overdue.';
        manualBanBtn.disabled = j.count === 0;
      } else {
        resultDiv.textContent = j.message;
      }
    } catch (e) {
      resultDiv.textContent = e.message;
    } finally {
      btn.disabled = false;
    }
  };

  function renderOverdueList() {
    const listDiv = document.getElementById('overdueList');
    if (overdueStudents.length === 0) {
      listDiv.innerHTML = '<div style="text-align:center; padding:8px;">No overdue students</div>';
      return;
    }
    listDiv.innerHTML = overdueStudents.map(s => `
      <div style="display:flex; justify-content:space-between; padding:8px; border-bottom:1px solid #eee;">
        <span><strong>${s.name}</strong> (${s.student_id})</span>
        <span style="color:${s.banned ? 'green' : 'red'}">${s.banned ? 'Banned' : s.duration_minutes + 'm'}</span>
      </div>
    `).join('');
  }

  document.getElementById('manualBanOverdueBtn').onclick = async () => {
    if (!confirm('Ban all overdue students?')) return;
    try {
      const r = await fetch('/api/auto_ban_overdue', { method: 'POST' });
      const j = await r.json();
      if (j.ok) {
        alert(j.message);
        document.getElementById('loadOverdueBtn').click();
      } else {
        alert(j.message);
      }
    } catch (e) { alert(e.message); }
  };

  // Students List
  let allStudents = [];
  let filteredStudents = [];
  document.getElementById('loadStudentsBtn').onclick = async () => {
    const btn = document.getElementById('loadStudentsBtn');
    const container = document.getElementById('studentListContainer');
    btn.disabled = true;
    btn.textContent = 'Loading...';
    try {
      const r = await fetch('/api/students');
      const j = await r.json();
      if (j.ok) {
        allStudents = j.students || [];
        filteredStudents = [...allStudents];
        renderStudentList();
        container.style.display = 'block';
        btn.textContent = 'Reload List';
      } else {
        alert(j.message);
      }
    } catch (e) { alert(e.message); }
    finally { btn.disabled = false; }
  };

  function renderStudentList() {
    const listDiv = document.getElementById('studentList');
    if (filteredStudents.length === 0) {
      listDiv.innerHTML = '<div style="padding:8px;">No students found</div>';
      return;
    }
    listDiv.innerHTML = filteredStudents.map(s => `
      <div style="display:flex; align-items:center; padding:8px; border-bottom:1px solid #eee; background:${s.banned ? 'var(--md-sys-color-error-container)' : 'transparent'}">
        <input type="checkbox" ${s.banned ? 'checked' : ''} onchange="toggleBan('${s.id}', '${s.name}', this.checked)" style="margin-right:12px;">
        <div style="flex:1">
          <div>${s.name}</div>
          <div style="font-size:12px; opacity:0.7">${s.id}</div>
        </div>
        ${s.banned ? 'üö´' : ''}
      </div>
    `).join('');
  }

  async function toggleBan(sid, name, ban) {
    document.getElementById('banResult').textContent = (ban ? 'Banning ' : 'Unbanning ') + name + '...';
    try {
      const ep = ban ? '/api/ban_student' : '/api/unban_student';
      const r = await fetch(ep, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({student_id: sid})});
      const j = await r.json();
      if (j.ok) {
        document.getElementById('banResult').textContent = 'Done.';
        const s = allStudents.find(x => x.id === sid);
        if (s) s.banned = ban;
        renderStudentList();
      } else {
        alert(j.message);
      }
    } catch (e) { alert(e.message); }
  }

  document.getElementById('studentSearchBox').oninput = (e) => {
    const term = e.target.value.toLowerCase();
    filteredStudents = allStudents.filter(s => s.name.toLowerCase().includes(term) || s.id.toLowerCase().includes(term));
    renderStudentList();
  };

  // Upload
  document.getElementById('sessionRosterForm').onsubmit = async (e) => {
    e.preventDefault();
    const fd = new FormData(e.target);
    try {
      const r = await fetch('/api/upload_session_roster', { method: 'POST', body: fd });
      const j = await r.json();
      if (j.ok) location.reload(); else alert(j.message);
    } catch (e) { alert(e.message); }
  };

  // Other buttons (kiosk, migrate, reset)
  const bindBtn = (id, url, confirmMsg) => {
    const btn = document.getElementById(id);
    if (btn) btn.onclick = async () => {
      if (confirmMsg && !confirm(confirmMsg)) return;
      try {
        const r = await fetch(url, { method: 'POST' });
        const j = await r.json();
        if (j.ok) location.reload(); else alert(j.message);
      } catch (e) { alert(e.message); }
    };
  };

  bindBtn('suspendKiosk', '/api/suspend_kiosk', 'Suspend Kiosk?');
  bindBtn('resumeKiosk', '/api/resume_kiosk');
  bindBtn('runMigration', '/api/migrate', 'Run Migration?');
  
  const resetBtn = document.getElementById('resetDbBtn');
  if (resetBtn) resetBtn.onclick = async () => {
    if (!confirm('DELETE ALL HISTORY?')) return;
    if (!confirm('REALLY?')) return;
    try {
      const r = await fetch('/api/reset_database', { method: 'POST' });
      const j = await r.json();
      alert(j.message);
      if (j.ok) location.reload();
    } catch(e) { alert(e.message); }
  };

  document.getElementById('clearSessionBtn').onclick = async () => {
    if(confirm('Clear Roster?')) {
      await fetch('/api/clear_session_roster', { method: 'POST' });
      location.reload();
    }
  };
  
  document.getElementById('settingsForm').onsubmit = async (e) => {
    e.preventDefault();
    const f = e.target;
    const payload = {
      room_name: f.room_name.value,
      capacity: Number(f.capacity.value),
      overdue_minutes: Number(f.overdue_minutes.value)
    };
    const r = await fetch('/api/settings', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
    const j = await r.json();
    alert(j.ok ? 'Saved' : j.message);
  };
</script>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  async function loadCharts() {
    try {
      const r = await fetch('/api/stats/week');
      const j = await r.json();
      const c1 = document.getElementById('chartTopUsage');
      const c2 = document.getElementById('chartTopOverdue');
      const c3 = document.getElementById('chartTopOverdueRate');
      // Update chart colors to match theme
      const colorPrimary = getComputedStyle(document.body).getPropertyValue('--md-sys-color-primary');
      const colorError = getComputedStyle(document.body).getPropertyValue('--md-sys-color-error');
      const colorTertiary = getComputedStyle(document.body).getPropertyValue('--md-sys-color-tertiary');
      
      new Chart(c1, { type: 'bar', data: { labels: j.top_usage.labels, datasets: [{ label: 'Count', data: j.top_usage.values, backgroundColor: colorPrimary }] }, options: { plugins: { legend: { display: false } }, indexAxis: 'y' } });
      new Chart(c2, { type: 'bar', data: { labels: j.top_overdue.labels, datasets: [{ label: 'Overdues', data: j.top_overdue.overdues, backgroundColor: colorError }] }, options: { plugins: { legend: { display: false } }, indexAxis: 'y' } });
      new Chart(c3, { type: 'bar', data: { labels: j.top_overdue_rate.labels, datasets: [{ label: 'Overdue %', data: j.top_overdue_rate.rates, backgroundColor: colorTertiary }] }, options: { plugins: { legend: { display: false } }, indexAxis: 'y' } });
    } catch (e) { }
  }
  loadCharts();
</script>
{% endblock %}