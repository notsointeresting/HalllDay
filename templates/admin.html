{% extends "base.html" %}
{% block content %}
<section class="admin">
  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
    <h2>Admin</h2>
    <a href="{{ url_for('admin_logout') }}" style="background: #6c757d; color: white; padding: 8px 16px; text-decoration: none; border-radius: 4px; font-size: 14px;">Logout</a>
  </div>
  <p>Open sessions: <strong>{{ open_count }}</strong> ‚Ä¢ Total sessions: <strong>{{ total }}</strong></p>

  <h3>Student Roster Management</h3>
  
  <!-- FERPA-Compliant Session Upload -->
  <div style="background: #e8f5e8; border: 1px solid #4caf50; border-radius: 4px; padding: 15px; margin-bottom: 15px;">
    <h4 style="color: #2e7d32; margin: 0 0 10px 0;">üîí FERPA-Compliant Upload (Recommended)</h4>
    <p style="margin: 0 0 10px 0; color: #2e7d32; font-size: 14px;">Student names stored in browser session only - not on external servers</p>
    <form id="sessionRosterForm">
      <input type="file" id="sessionFileInput" name="file" accept=".csv" style="margin-right: 10px;">
      <button type="submit" style="background: #4caf50; color: white; margin-right: 10px;">Upload to Session Only</button>
      <button type="button" id="sessionUploadBtn" style="background: #2196f3; color: white;">Alternative Upload</button>
    </form>
    <div id="sessionRosterResult"></div>
    {% if roster_count > 0 %}
      <p style="margin: 10px 0 0 0; color: #2e7d32; font-size: 14px;">‚úÖ Session roster: {{ roster_count }} students loaded</p>
    {% endif %}
    
    <!-- Debug Authentication -->
    <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #4caf50;">
      <button type="button" id="testAuthBtn" style="background: #9c27b0; color: white; font-size: 12px;">Test Authentication</button>
      <div id="testAuthResult" style="font-size: 12px; margin-top: 5px;"></div>
    </div>
  </div>

  <!-- Legacy Database Upload -->
  <div style="background: #fff3cd; border: 1px solid #ffc107; border-radius: 4px; padding: 15px;">
    <h4 style="color: #856404; margin: 0 0 10px 0;">‚ö†Ô∏è Legacy Upload (Database Storage)</h4>
    <p style="margin: 0 0 10px 0; color: #856404; font-size: 14px;">Stores student names in database - may not be FERPA compliant</p>
    <form id="importForm">
      <input type="file" id="legacyFileInput" name="file" accept=".csv" style="margin-right: 10px;">
      <button type="submit" style="background: #ffc107; color: #212529; margin-right: 10px;">Upload to Database</button>
      <button type="button" id="legacyUploadBtn" style="background: #ff9800; color: white;">Alternative Upload</button>
    </form>
    <div id="importResult"></div>
    
    <!-- Clear Legacy Database -->
    <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #ffc107;">
      <h5 style="color: #856404; margin: 0 0 10px 0;">üîí Anonymize Legacy Database</h5>
      <p style="margin: 0 0 10px 0; color: #856404; font-size: 12px;">Replace all student names with anonymous IDs (keeps session roster intact)</p>
      <button type="button" id="clearDatabaseBtn" style="background: #dc3545; color: white; margin-right: 10px;">Anonymize Database Names</button>
      <div id="clearDatabaseResult"></div>
    </div>
  </div>

  <h3>Settings</h3>
  <div style="margin:6px 0 12px 0; display:flex; gap:12px; align-items:center;">
    {% if sheets_status == 'ok' %}
      <span style="padding:2px 8px; border-radius:12px; background:#e6ffed; color:#1f7a1f; border:1px solid #c6f6d5;">Sheets: OK</span>
      {% if sheets_link %}<a href="{{ sheets_link }}" target="_blank" rel="noopener">Open Logs Sheet</a>{% endif %}
    {% elif sheets_status == 'degraded' %}
      <span style="padding:2px 8px; border-radius:12px; background:#fffbea; color:#975a16; border:1px solid #f6e05e;">Sheets: Degraded</span>
      {% if sheets_link %}<a href="{{ sheets_link }}" target="_blank" rel="noopener">Open Logs Sheet</a>{% endif %}
    {% else %}
      <span style="padding:2px 8px; border-radius:12px; background:#edf2f7; color:#4a5568; border:1px solid #e2e8f0;">Sheets: Off</span>
    {% endif %}
  </div>
  <form id="settingsForm">
    <label>Room name <input name="room_name" value="{{ settings.room_name }}" /></label>
    <label>Capacity <input type="number" min="1" step="1" name="capacity" value="{{ settings.capacity }}" /></label>
    <label>Overdue minutes <input type="number" min="1" step="1" name="overdue_minutes" value="{{ settings.overdue_minutes }}" /></label>
    <button type="submit">Save</button>
  </form>
  <div id="settingsResult"></div>

  <h3>Weekly Focused Insights</h3>
  <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap:16px;">
    <div>
      <h4>Top users (7 days)</h4>
      <canvas id="chartTopUsage" height="160"></canvas>
    </div>
    <div>
      <h4>Most overdue (count)</h4>
      <canvas id="chartTopOverdue" height="160"></canvas>
    </div>
    <div>
      <h4>Highest overdue rate %</h4>
      <canvas id="chartTopOverdueRate" height="160"></canvas>
    </div>
  </div>

  <h3>Student Data Summary</h3>
  <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
    <div style="background: #e8f5e8; border: 1px solid #4caf50; border-radius: 4px; padding: 15px;">
      <h4 style="color: #2e7d32; margin: 0 0 10px 0;">üîí Session Roster (FERPA Compliant)</h4>
      <p style="margin: 0; font-size: 24px; font-weight: bold; color: #2e7d32;">{{ roster_count }} students</p>
      <p style="margin: 5px 0 0 0; color: #2e7d32; font-size: 12px;">Stored in browser session only</p>
    </div>
    <div style="background: #fff3cd; border: 1px solid #ffc107; border-radius: 4px; padding: 15px;">
      <h4 style="color: #856404; margin: 0 0 10px 0;">‚ö†Ô∏è Database Students (Legacy)</h4>
      <p style="margin: 0; font-size: 24px; font-weight: bold; color: #856404;">{{ students|length }} students</p>
      <p style="margin: 5px 0 0 0; color: #856404; font-size: 12px;">Stored in external database</p>
    </div>
  </div>

  {% if students|length > 0 %}
  <details style="margin-bottom: 20px;">
    <summary style="cursor: pointer; font-weight: bold; color: #856404;">View Database Students ({{ students|length }})</summary>
    <ul class="students" style="margin-top: 10px;">
      {% for s in students %}<li>{{ s.id }} ‚Äî {{ s.name }}</li>{% endfor %}
    </ul>
  </details>
  {% endif %}

  <h3>Kiosk Control</h3>
  <div style="margin-bottom: 16px;">
    {% if settings.kiosk_suspended %}
      <button id="resumeKiosk" style="background: #28a745; color: white;">Resume Kiosk</button>
      <span style="color: #dc3545; font-weight: bold;">‚ö† Kiosk is currently SUSPENDED</span>
    {% else %}
      <button id="suspendKiosk" style="background: #dc3545; color: white;">Suspend Kiosk</button>
      <span style="color: #28a745;">‚úì Kiosk is active</span>
    {% endif %}
  </div>

  <h3>Database</h3>
  <div style="margin-bottom:16px;">
    <button id="runMigration" style="background:#007bff;color:white;">Run Database Migration</button>
    <span id="migrationResult"></span>
  </div>

  <h3>Force End</h3>
  <button id="override">End Current Session</button>
  <a href="{{ url_for('export_csv') }}">Download today's CSV</a>
</section>

<script>
console.log('Admin panel JavaScript loaded');

// Test if forms exist
document.addEventListener('DOMContentLoaded', function() {
  console.log('DOM loaded');
  console.log('sessionRosterForm exists:', !!document.getElementById('sessionRosterForm'));
  console.log('importForm exists:', !!document.getElementById('importForm'));
});

document.getElementById('override').onclick = async () => {
  const r = await fetch('/api/override_end', {method:'POST'});
  const j = await r.json();
  alert(j.ok ? 'Ended.' : (j.message || 'Error'));
};

// FERPA-Compliant Session Upload
document.getElementById('sessionRosterForm').onsubmit = async (e) => {
  e.preventDefault();
  console.log('Session roster form submitted');
  
  const fileInput = e.target.querySelector('input[type="file"]');
  const resultDiv = document.getElementById('sessionRosterResult');
  
  if (!fileInput.files || fileInput.files.length === 0) {
    resultDiv.innerHTML = `<p style="color: #d32f2f; margin: 5px 0 0 0;">‚ùå Please select a CSV file</p>`;
    return;
  }
  
  resultDiv.innerHTML = `<p style="color: #2196f3; margin: 5px 0 0 0;">üì§ Uploading...</p>`;
  
  try {
    const fd = new FormData(e.target);
    console.log('Sending request to /api/upload_session_roster');
    const r = await fetch('/api/upload_session_roster', {method:'POST', body: fd});
    console.log('Response status:', r.status);
    const j = await r.json();
    console.log('session_roster_upload response:', j);
    
    if (j.ok) {
      resultDiv.innerHTML = `<p style="color: #2e7d32; margin: 5px 0 0 0;">‚úÖ ${j.imported} students loaded to session (FERPA compliant)</p>`;
      setTimeout(() => location.reload(), 1500); // Refresh to show updated count
    } else {
      resultDiv.innerHTML = `<p style="color: #d32f2f; margin: 5px 0 0 0;">‚ùå ${j.message || 'Upload failed'}</p>`;
    }
  } catch (error) {
    console.error('Upload error:', error);
    resultDiv.innerHTML = `<p style="color: #d32f2f; margin: 5px 0 0 0;">‚ùå Network error: ${error.message}</p>`;
  }
};

// Legacy Database Upload
document.getElementById('importForm').onsubmit = async (e) => {
  e.preventDefault();
  console.log('Legacy import form submitted');
  
  const fileInput = e.target.querySelector('input[type="file"]');
  const resultDiv = document.getElementById('importResult');
  
  if (!fileInput.files || fileInput.files.length === 0) {
    resultDiv.textContent = 'Please select a CSV file';
    return;
  }
  
  resultDiv.textContent = 'Uploading...';
  
  try {
    const fd = new FormData(e.target);
    console.log('Sending request to /api/import_roster');
    const r = await fetch('/api/import_roster', {method:'POST', body: fd});
    console.log('Response status:', r.status);
    const j = await r.json();
    console.log('import_roster response:', j);
    resultDiv.textContent = j.ok ? `Imported ${j.imported} students` : (j.message || 'Upload failed');
  } catch (error) {
    console.error('Import error:', error);
    resultDiv.textContent = `Network error: ${error.message}`;
  }
};

// Alternative button handlers (in case form submission doesn't work)
document.addEventListener('DOMContentLoaded', function() {
  // Session roster alternative upload
  const sessionUploadBtn = document.getElementById('sessionUploadBtn');
  if (sessionUploadBtn) {
    sessionUploadBtn.onclick = async () => {
      console.log('Session alternative button clicked');
      const fileInput = document.getElementById('sessionFileInput');
      const resultDiv = document.getElementById('sessionRosterResult');
      
      if (!fileInput.files || fileInput.files.length === 0) {
        resultDiv.innerHTML = `<p style="color: #d32f2f; margin: 5px 0 0 0;">‚ùå Please select a CSV file first</p>`;
        return;
      }
      
      resultDiv.innerHTML = `<p style="color: #2196f3; margin: 5px 0 0 0;">üì§ Uploading via alternative method...</p>`;
      
      try {
        const fd = new FormData();
        fd.append('file', fileInput.files[0]);
        console.log('Sending alternative request to /api/upload_session_roster');
        const r = await fetch('/api/upload_session_roster', {method:'POST', body: fd});
        console.log('Alternative response status:', r.status);
        const j = await r.json();
        console.log('Alternative session_roster_upload response:', j);
        
        if (j.ok) {
          resultDiv.innerHTML = `<p style="color: #2e7d32; margin: 5px 0 0 0;">‚úÖ ${j.imported} students loaded to session (FERPA compliant)</p>`;
          setTimeout(() => location.reload(), 1500);
        } else {
          resultDiv.innerHTML = `<p style="color: #d32f2f; margin: 5px 0 0 0;">‚ùå ${j.message || 'Upload failed'}</p>`;
        }
      } catch (error) {
        console.error('Alternative upload error:', error);
        resultDiv.innerHTML = `<p style="color: #d32f2f; margin: 5px 0 0 0;">‚ùå Network error: ${error.message}</p>`;
      }
    };
  }
  
  // Legacy roster alternative upload
  const legacyUploadBtn = document.getElementById('legacyUploadBtn');
  if (legacyUploadBtn) {
    legacyUploadBtn.onclick = async () => {
      console.log('Legacy alternative button clicked');
      const fileInput = document.getElementById('legacyFileInput');
      const resultDiv = document.getElementById('importResult');
      
      if (!fileInput.files || fileInput.files.length === 0) {
        resultDiv.textContent = 'Please select a CSV file first';
        return;
      }
      
      resultDiv.textContent = 'Uploading via alternative method...';
      
      try {
        const fd = new FormData();
        fd.append('file', fileInput.files[0]);
        console.log('Sending alternative request to /api/import_roster');
        const r = await fetch('/api/import_roster', {method:'POST', body: fd});
        console.log('Alternative response status:', r.status);
        const j = await r.json();
        console.log('Alternative import_roster response:', j);
        resultDiv.textContent = j.ok ? `Imported ${j.imported} students` : (j.message || 'Upload failed');
      } catch (error) {
        console.error('Alternative import error:', error);
        resultDiv.textContent = `Network error: ${error.message}`;
      }
    };
  }
  
  // Clear legacy database button
  const clearDatabaseBtn = document.getElementById('clearDatabaseBtn');
  if (clearDatabaseBtn) {
    clearDatabaseBtn.onclick = async () => {
      const confirmed = confirm(
        'Are you sure you want to anonymize all student names in the database?\n\n' +
        'üîí This will replace student names with anonymous IDs (e.g., "Student_1234").\n' +
        '‚úÖ Your session roster will remain intact and functional.\n' +
        'üìä All session data and functionality will continue normally.\n' +
        'üõ°Ô∏è Database will be FERPA compliant after this action.\n\n' +
        'This action cannot be undone.'
      );
      
      if (!confirmed) return;
      
      console.log('Clear database button clicked');
      const resultDiv = document.getElementById('clearDatabaseResult');
      resultDiv.innerHTML = `<p style="color: #dc3545; margin: 5px 0 0 0;">üîí Anonymizing database...</p>`;
      
      try {
        const r = await fetch('/api/clear_database_students', {method:'POST'});
        console.log('Clear database response status:', r.status);
        const j = await r.json();
        console.log('Clear database response:', j);
        
        if (j.ok) {
          resultDiv.innerHTML = `<p style="color: #28a745; margin: 5px 0 0 0;">‚úÖ ${j.message} (${j.cleared} students anonymized)</p>`;
        } else {
          resultDiv.innerHTML = `<p style="color: #dc3545; margin: 5px 0 0 0;">‚ùå ${j.message || 'Anonymization failed'}</p>`;
        }
      } catch (error) {
        console.error('Clear database error:', error);
        resultDiv.innerHTML = `<p style="color: #dc3545; margin: 5px 0 0 0;">‚ùå Network error: ${error.message}</p>`;
      }
    };
  }
  
  // Test authentication button
  const testAuthBtn = document.getElementById('testAuthBtn');
  if (testAuthBtn) {
    testAuthBtn.onclick = async () => {
      console.log('Testing authentication...');
      const resultDiv = document.getElementById('testAuthResult');
      resultDiv.textContent = 'Testing...';
      
      try {
        const r = await fetch('/api/test_auth', {method:'POST'});
        console.log('Test auth response status:', r.status);
        const j = await r.json();
        console.log('Test auth response:', j);
        
        if (j.ok) {
          resultDiv.style.color = '#2e7d32';
          resultDiv.textContent = '‚úÖ Authentication working';
        } else {
          resultDiv.style.color = '#d32f2f';
          resultDiv.textContent = `‚ùå Auth failed: ${j.message}`;
        }
      } catch (error) {
        console.error('Test auth error:', error);
        resultDiv.style.color = '#d32f2f';
        resultDiv.textContent = `‚ùå Error: ${error.message}`;
      }
    };
  }
});

document.getElementById('settingsForm').onsubmit = async (e) => {
  e.preventDefault();
  const f = e.target;
  const payload = {
    room_name: f.room_name.value,
    capacity: Number(f.capacity.value),
    overdue_minutes: Number(f.overdue_minutes.value)
  };
  const r = await fetch('/api/settings', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)});
  const j = await r.json();
  console.log('settings_update', j);
  document.getElementById('settingsResult').textContent = j.ok ? 'Saved.' : (j.message || 'Error');
};

// Suspend/Resume kiosk handlers
const suspendBtn = document.getElementById('suspendKiosk');
const resumeBtn = document.getElementById('resumeKiosk');

if (suspendBtn) {
  suspendBtn.onclick = async () => {
    if (confirm('Are you sure you want to suspend the kiosk? Students will not be able to scan in/out.')) {
      try{
        const r = await fetch('/api/suspend_kiosk', {method:'POST'});
        const j = await r.json();
        console.log('suspend', j);
        if (j.ok) {
          location.reload();
        } else {
          alert(j.message || 'Error suspending kiosk');
        }
      }catch(e){
        console.error('suspend error', e);
        alert('Error suspending kiosk');
      }
    }
  };
}

if (resumeBtn) {
  resumeBtn.onclick = async () => {
    try{
      const r = await fetch('/api/resume_kiosk', {method:'POST'});
      const j = await r.json();
      console.log('resume', j);
      if (j.ok) {
        location.reload();
      } else {
        alert(j.message || 'Error resuming kiosk');
      }
    }catch(e){
      console.error('resume error', e);
      alert('Error resuming kiosk');
    }
  };
}

const migrateBtn = document.getElementById('runMigration');
if (migrateBtn) {
  migrateBtn.onclick = async () => {
    if (!confirm('Run database migration now?')) return;
    migrateBtn.disabled = true;
    document.getElementById('migrationResult').textContent = 'Running...';
    try {
      const r = await fetch('/api/migrate', {method:'POST'});
      const j = await r.json();
      console.log('migrate', j);
      if (j.ok) {
        document.getElementById('migrationResult').textContent = 'Migration completed.';
        setTimeout(()=>location.reload(), 1000);
      } else {
        document.getElementById('migrationResult').textContent = j.message || 'Migration failed';
      }
    } catch (e) {
      console.error('migration error', e);
      document.getElementById('migrationResult').textContent = 'Migration failed';
    } finally {
      migrateBtn.disabled = false;
    }
  };
}
</script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
async function loadCharts(){
  try{
    const r = await fetch('/api/stats/week');
    const j = await r.json();
    const c1 = document.getElementById('chartTopUsage');
    const c2 = document.getElementById('chartTopOverdue');
    const c3 = document.getElementById('chartTopOverdueRate');
    new Chart(c1, {type:'bar', data:{labels:j.top_usage.labels, datasets:[{label:'Count', data:j.top_usage.values, backgroundColor:'rgba(41,183,101,0.6)'}]}, options:{plugins:{legend:{display:false}}, indexAxis:'y'}});
    new Chart(c2, {type:'bar', data:{labels:j.top_overdue.labels, datasets:[{label:'Overdues', data:j.top_overdue.overdues, backgroundColor:'rgba(242, 201, 76, 0.7)'}]}, options:{plugins:{legend:{display:false}}, indexAxis:'y'}});
    new Chart(c3, {type:'bar', data:{labels:j.top_overdue_rate.labels, datasets:[{label:'Overdue %', data:j.top_overdue_rate.rates, backgroundColor:'rgba(217, 83, 79, 0.7)'}]}, options:{plugins:{legend:{display:false}}, indexAxis:'y'}});
  }catch(e){}
}
loadCharts();
</script>
{% endblock %}
