{% extends "base.html" %}
{% block content %}
<section class="admin">
  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
    <h2>Admin</h2>
    <a href="{{ url_for('admin_logout') }}" style="background: #6c757d; color: white; padding: 8px 16px; text-decoration: none; border-radius: 4px; font-size: 14px;">Logout</a>
  </div>
  <p>Open sessions: <strong>{{ open_count }}</strong> • Total sessions: <strong>{{ total }}</strong></p>

  <h3>Student Roster Management</h3>
  
  <!-- FERPA-Compliant Session Upload -->
  <div style="background: #e8f5e8; border: 1px solid #4caf50; border-radius: 4px; padding: 15px; margin-bottom: 15px;">
    <h4 style="color: #2e7d32; margin: 0 0 10px 0;">🔒 FERPA-Compliant Upload (Recommended)</h4>
    <p style="margin: 0 0 10px 0; color: #2e7d32; font-size: 14px;">Student names stored in browser session only - not on external servers</p>
    <form id="sessionRosterForm">
      <input type="file" id="sessionFileInput" name="file" accept=".csv" style="margin-right: 10px;">
      <button type="submit" style="background: #4caf50; color: white; margin-right: 10px;">Upload to Session Only</button>
      <button type="button" id="sessionUploadBtn" style="background: #2196f3; color: white;">Alternative Upload</button>
    </form>
    <div id="sessionRosterResult"></div>
    {% if session_roster_count > 0 %}
      <p style="margin: 10px 0 0 0; color: #2e7d32; font-size: 14px;">✅ Session roster: {{ session_roster_count }} students loaded</p>
    {% endif %}
    {% if memory_roster_count > 0 %}
      <p style="margin: 5px 0 0 0; color: #1976d2; font-size: 14px;">🖥️ Display roster: {{ memory_roster_count }} students 
      {% if memory_expires_in_hours is not none %}
        (expires in {{ memory_expires_in_hours }}h)
      {% endif %}
      </p>
    {% endif %}
    
    <!-- Debug Authentication -->
    <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #4caf50;">
      <button type="button" id="testAuthBtn" style="background: #9c27b0; color: white; font-size: 12px; margin-right: 5px;">Test Authentication</button>
      <button type="button" id="viewSessionBtn" style="background: #607d8b; color: white; font-size: 12px; margin-right: 5px;">View Session Roster</button>
      <button type="button" id="clearSessionBtn" style="background: #f44336; color: white; font-size: 12px;">Clear Session</button>
      <div id="testAuthResult" style="font-size: 12px; margin-top: 5px;"></div>
      <div id="sessionDebugResult" style="font-size: 12px; margin-top: 5px; max-height: 200px; overflow-y: auto;"></div>
    </div>
  </div>



  <h3>Settings</h3>
  <div style="margin:6px 0 12px 0; display:flex; gap:12px; align-items:center;">
    {% if sheets_status == 'ok' %}
      <span style="padding:2px 8px; border-radius:12px; background:#e6ffed; color:#1f7a1f; border:1px solid #c6f6d5;">Sheets: OK</span>
      {% if sheets_link %}<a href="{{ sheets_link }}" target="_blank" rel="noopener">Open Logs Sheet</a>{% endif %}
    {% elif sheets_status == 'degraded' %}
      <span style="padding:2px 8px; border-radius:12px; background:#fffbea; color:#975a16; border:1px solid #f6e05e;">Sheets: Degraded</span>
      {% if sheets_link %}<a href="{{ sheets_link }}" target="_blank" rel="noopener">Open Logs Sheet</a>{% endif %}
    {% else %}
      <span style="padding:2px 8px; border-radius:12px; background:#edf2f7; color:#4a5568; border:1px solid #e2e8f0;">Sheets: Off</span>
    {% endif %}
  </div>
  <form id="settingsForm">
    <label>Room name <input name="room_name" value="{{ settings.room_name }}" /></label>
    <label>Capacity <input type="number" min="1" step="1" name="capacity" value="{{ settings.capacity }}" /></label>
    <label>Overdue minutes <input type="number" min="1" step="1" name="overdue_minutes" value="{{ settings.overdue_minutes }}" /></label>
    <button type="submit">Save</button>
  </form>
  <div id="settingsResult"></div>

  <h3>Weekly Focused Insights</h3>
  <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap:16px;">
    <div>
      <h4>Top users (7 days)</h4>
      <canvas id="chartTopUsage" height="160"></canvas>
    </div>
    <div>
      <h4>Most overdue (count)</h4>
      <canvas id="chartTopOverdue" height="160"></canvas>
    </div>
    <div>
      <h4>Highest overdue rate %</h4>
      <canvas id="chartTopOverdueRate" height="160"></canvas>
    </div>
  </div>

  <h3>Student Roster Status</h3>
  <div style="background: #e8f5e8; border: 1px solid #4caf50; border-radius: 4px; padding: 15px; margin-bottom: 20px;">
    <h4 style="color: #2e7d32; margin: 0 0 10px 0;">🔒 FERPA-Compliant Roster Status</h4>
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
      <div>
        <p style="margin: 0; font-size: 18px; font-weight: bold; color: #2e7d32;">{{ session_roster_count }} students</p>
        <p style="margin: 5px 0 0 0; color: #2e7d32; font-size: 12px;">Session roster (admin access)</p>
      </div>
      <div>
        <p style="margin: 0; font-size: 18px; font-weight: bold; color: #1976d2;">{{ memory_roster_count }} students</p>
        <p style="margin: 5px 0 0 0; color: #1976d2; font-size: 12px;">Display roster 
        {% if memory_expires_in_hours is not none %}
          (expires in {{ memory_expires_in_hours }}h)
        {% endif %}
        </p>
      </div>
    </div>
    <p style="margin: 10px 0 0 0; color: #666; font-size: 12px;">All student data stored in memory only - no persistent external storage</p>
  </div>

  <h3>Overdue Students (Auto-Ban)</h3>
  <div style="background: #ffebee; border: 1px solid #f44336; border-radius: 4px; padding: 15px; margin-bottom: 20px;">
    <h4 style="color: #c62828; margin: 0 0 10px 0;">⚠️ Currently Overdue Students</h4>
    <p style="margin: 0 0 10px 0; color: #c62828; font-size: 14px;">Students who are currently overdue can be automatically banned. Overdue threshold: <strong>{{ settings.overdue_minutes }} minutes</strong></p>
    <div style="display: flex; gap: 10px; margin-bottom: 10px;">
      <button id="loadOverdueBtn" style="background: #ff9800; color: white;">Check Overdue Students</button>
      <button id="autoBanOverdueBtn" style="background: #f44336; color: white;" disabled>Auto-Ban All Overdue</button>
    </div>
    <div id="overdueListContainer" style="display: none;">
      <div style="margin: 10px 0; padding: 8px; background: white; border-radius: 4px;">
        <div id="overdueList" style="padding: 10px;"></div>
      </div>
    </div>
    <div id="overdueResult" style="margin-top: 10px; font-size: 14px;"></div>
  </div>

  <h3>Restroom Ban Management</h3>
  <div style="background: #fff3cd; border: 1px solid #ffc107; border-radius: 4px; padding: 15px; margin-bottom: 20px;">
    <h4 style="color: #856404; margin: 0 0 10px 0;">🚫 Student Restroom Bans</h4>
    <p style="margin: 0 0 10px 0; color: #856404; font-size: 14px;">Ban students from using the restroom. Banned students can still scan back in to end their current trip, but cannot start new trips. They will see a red warning when they try to scan out.</p>
    <button id="loadStudentsBtn" style="background: #007bff; color: white; margin-bottom: 10px;">Load Student List</button>
    <div id="studentListContainer" style="display: none;">
      <div style="margin: 10px 0; padding: 8px; background: white; border-radius: 4px;">
        <input type="text" id="studentSearchBox" placeholder="Search students..." style="width: 100%; padding: 8px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 4px;">
        <div style="max-height: 300px; overflow-y: auto; border: 1px solid #ddd; border-radius: 4px;">
          <div id="studentList" style="padding: 10px;"></div>
        </div>
      </div>
      <div id="banResult" style="margin-top: 10px; font-size: 14px;"></div>
    </div>
  </div>

  <h3>Kiosk Control</h3>
  <div style="margin-bottom: 16px;">
    {% if settings.kiosk_suspended %}
      <button id="resumeKiosk" style="background: #28a745; color: white;">Resume Kiosk</button>
      <span style="color: #dc3545; font-weight: bold;">⚠ Kiosk is currently SUSPENDED</span>
    {% else %}
      <button id="suspendKiosk" style="background: #dc3545; color: white;">Suspend Kiosk</button>
      <span style="color: #28a745;">✓ Kiosk is active</span>
    {% endif %}
  </div>

  <h3>Database</h3>
  <div style="margin-bottom:16px;">
    <button id="runMigration" style="background:#007bff;color:white;">Run Database Migration</button>
    <span id="migrationResult"></span>
  </div>

  <!-- Danger Zone -->
  <div style="margin-bottom:16px; padding:12px; border:1px solid #dc3545; background:#fff5f5;">
    <h4 style="color:#dc3545; margin:0 0 8px 0;">Danger Zone</h4>
    <p style="margin:0 0 8px 0; color:#dc3545; font-size:13px;">This will permanently DELETE all session history from the database. Your current browser session roster will remain intact.</p>
    <button id="resetDbBtn" style="background:#dc3545; color:white;">Delete ALL Session History</button>
    <span id="resetDbResult" style="margin-left:8px;"></span>
  </div>

  <h3>Force End</h3>
  <button id="override">End Current Session</button>
  <a href="{{ url_for('export_csv') }}">Download today's CSV</a>
</section>

<script>
console.log('Admin panel JavaScript loaded');

// Test if forms exist
document.addEventListener('DOMContentLoaded', function() {
  console.log('DOM loaded');
  console.log('sessionRosterForm exists:', !!document.getElementById('sessionRosterForm'));
});

document.getElementById('override').onclick = async () => {
  const r = await fetch('/api/override_end', {method:'POST'});
  const j = await r.json();
  alert(j.ok ? 'Ended.' : (j.message || 'Error'));
};

// Overdue Student Management
let overdueStudents = [];

document.getElementById('loadOverdueBtn').onclick = async () => {
  const btn = document.getElementById('loadOverdueBtn');
  const autoBanBtn = document.getElementById('autoBanOverdueBtn');
  const container = document.getElementById('overdueListContainer');
  const resultDiv = document.getElementById('overdueResult');
  
  btn.disabled = true;
  btn.textContent = 'Checking...';
  resultDiv.textContent = '';
  autoBanBtn.disabled = true;
  
  try {
    const r = await fetch('/api/overdue_students');
    const j = await r.json();
    
    if (j.ok) {
      overdueStudents = j.students || [];
      renderOverdueList();
      container.style.display = 'block';
      btn.textContent = `Found ${j.count} overdue student(s)`;
      
      if (j.count > 0) {
        resultDiv.style.color = '#f44336';
        resultDiv.textContent = `⚠️ ${j.count} student(s) are overdue (threshold: ${j.overdue_threshold_minutes} min)`;
        autoBanBtn.disabled = false;
      } else {
        resultDiv.style.color = '#28a745';
        resultDiv.textContent = `✓ No students are currently overdue`;
      }
    } else {
      resultDiv.style.color = '#dc3545';
      resultDiv.textContent = `❌ Failed: ${j.message}`;
      btn.textContent = 'Check Overdue Students';
    }
  } catch (error) {
    console.error('Load overdue students error:', error);
    resultDiv.style.color = '#dc3545';
    resultDiv.textContent = `❌ Error: ${error.message}`;
    btn.textContent = 'Check Overdue Students';
  } finally {
    btn.disabled = false;
  }
};

function renderOverdueList() {
  const listDiv = document.getElementById('overdueList');
  
  if (overdueStudents.length === 0) {
    listDiv.innerHTML = '<p style="color: #28a745; text-align: center; font-weight: bold;">✓ No students are currently overdue</p>';
    return;
  }
  
  const notBannedCount = overdueStudents.filter(s => !s.banned).length;
  
  let html = '';
  if (notBannedCount > 0) {
    html += `<p style="color: #f44336; font-weight: bold; margin-bottom: 10px;">⚠️ ${notBannedCount} overdue student(s) not yet banned</p>`;
  }
  
  overdueStudents.forEach(student => {
    const bgColor = student.banned ? '#e8f5e9' : '#ffebee';
    const textColor = student.banned ? '#2e7d32' : '#c62828';
    const statusText = student.banned ? '✓ Already Banned' : `⚠️ ${student.duration_minutes} min overdue`;
    html += `
      <div style="padding: 10px; margin: 4px 0; background: ${bgColor}; border-radius: 4px; border: 1px solid ${student.banned ? '#81c784' : '#e57373'};">
        <div style="display: flex; justify-content: space-between; align-items: center;">
          <div style="flex: 1;">
            <span style="font-weight: bold; color: ${textColor};">${student.name}</span>
            <span style="color: #666; font-size: 12px; margin-left: 8px;">(${student.student_id})</span>
          </div>
          <div style="text-align: right;">
            <span style="color: ${textColor}; font-weight: bold; font-size: 14px;">${statusText}</span>
          </div>
        </div>
      </div>
    `;
  });
  
  listDiv.innerHTML = html;
}

document.getElementById('autoBanOverdueBtn').onclick = async () => {
  if (!confirm('Ban all overdue students from starting new restroom trips? They can still scan back in to end their current trip.')) {
    return;
  }
  
  const btn = document.getElementById('autoBanOverdueBtn');
  const resultDiv = document.getElementById('overdueResult');
  
  btn.disabled = true;
  btn.textContent = 'Banning...';
  resultDiv.textContent = 'Processing auto-ban...';
  resultDiv.style.color = '#007bff';
  
  try {
    const r = await fetch('/api/auto_ban_overdue', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'}
    });
    const j = await r.json();
    
    if (j.ok) {
      resultDiv.style.color = '#28a745';
      resultDiv.textContent = `✓ ${j.message}`;
      
      // Refresh the overdue list
      setTimeout(() => {
        document.getElementById('loadOverdueBtn').click();
      }, 1500);
    } else {
      resultDiv.style.color = '#dc3545';
      resultDiv.textContent = `❌ ${j.message}`;
      btn.disabled = false;
      btn.textContent = 'Auto-Ban All Overdue';
    }
  } catch (error) {
    console.error('Auto-ban error:', error);
    resultDiv.style.color = '#dc3545';
    resultDiv.textContent = `❌ Error: ${error.message}`;
    btn.disabled = false;
    btn.textContent = 'Auto-Ban All Overdue';
  }
};

// Student Ban Management
let allStudents = [];
let filteredStudents = [];

document.getElementById('loadStudentsBtn').onclick = async () => {
  const btn = document.getElementById('loadStudentsBtn');
  const container = document.getElementById('studentListContainer');
  const resultDiv = document.getElementById('banResult');
  
  btn.disabled = true;
  btn.textContent = 'Loading...';
  resultDiv.textContent = '';
  
  try {
    const r = await fetch('/api/students');
    const j = await r.json();
    
    if (j.ok) {
      allStudents = j.students || [];
      filteredStudents = [...allStudents];
      renderStudentList();
      container.style.display = 'block';
      btn.textContent = `Loaded ${j.count} students`;
      resultDiv.style.color = '#28a745';
      resultDiv.textContent = `✓ ${j.count} students loaded`;
    } else {
      resultDiv.style.color = '#dc3545';
      resultDiv.textContent = `❌ Failed: ${j.message}`;
      btn.textContent = 'Load Student List';
    }
  } catch (error) {
    console.error('Load students error:', error);
    resultDiv.style.color = '#dc3545';
    resultDiv.textContent = `❌ Error: ${error.message}`;
    btn.textContent = 'Load Student List';
  } finally {
    btn.disabled = false;
  }
};

function renderStudentList() {
  const listDiv = document.getElementById('studentList');
  
  if (filteredStudents.length === 0) {
    listDiv.innerHTML = '<p style="color: #666; text-align: center;">No students found</p>';
    return;
  }
  
  const bannedCount = filteredStudents.filter(s => s.banned).length;
  
  let html = '';
  if (bannedCount > 0) {
    html += `<p style="color: #dc3545; font-weight: bold; margin-bottom: 10px;">⚠️ ${bannedCount} student(s) currently banned</p>`;
  }
  
  filteredStudents.forEach(student => {
    const checked = student.banned ? 'checked' : '';
    const bgColor = student.banned ? '#ffebee' : 'transparent';
    const textColor = student.banned ? '#c62828' : '#333';
    html += `
      <div style="padding: 8px; margin: 4px 0; background: ${bgColor}; border-radius: 4px; display: flex; align-items: center; gap: 10px;">
        <input type="checkbox" 
               id="ban_${student.id}" 
               data-student-id="${student.id}" 
               data-student-name="${student.name}"
               ${checked}
               onchange="toggleBan('${student.id}', '${student.name}', this.checked)"
               style="cursor: pointer; width: 18px; height: 18px;">
        <label for="ban_${student.id}" style="cursor: pointer; flex: 1; color: ${textColor}; font-weight: ${student.banned ? 'bold' : 'normal'};">
          ${student.name} ${student.banned ? '🚫' : ''}
        </label>
        <span style="color: #666; font-size: 12px;">${student.id}</span>
      </div>
    `;
  });
  
  listDiv.innerHTML = html;
}

async function toggleBan(studentId, studentName, shouldBan) {
  const resultDiv = document.getElementById('banResult');
  resultDiv.textContent = shouldBan ? `Banning ${studentName}...` : `Unbanning ${studentName}...`;
  resultDiv.style.color = '#007bff';
  
  try {
    const endpoint = shouldBan ? '/api/ban_student' : '/api/unban_student';
    const r = await fetch(endpoint, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({student_id: studentId})
    });
    const j = await r.json();
    
    if (j.ok) {
      resultDiv.style.color = '#28a745';
      resultDiv.textContent = `✓ ${j.message}`;
      
      // Update local state
      const student = allStudents.find(s => s.id === studentId);
      if (student) {
        student.banned = shouldBan;
      }
      const filteredStudent = filteredStudents.find(s => s.id === studentId);
      if (filteredStudent) {
        filteredStudent.banned = shouldBan;
      }
      
      renderStudentList();
    } else {
      resultDiv.style.color = '#dc3545';
      resultDiv.textContent = `❌ ${j.message}`;
      
      // Revert checkbox
      const checkbox = document.getElementById(`ban_${studentId}`);
      if (checkbox) checkbox.checked = !shouldBan;
    }
  } catch (error) {
    console.error('Toggle ban error:', error);
    resultDiv.style.color = '#dc3545';
    resultDiv.textContent = `❌ Error: ${error.message}`;
    
    // Revert checkbox
    const checkbox = document.getElementById(`ban_${studentId}`);
    if (checkbox) checkbox.checked = !shouldBan;
  }
}

// Search functionality
document.getElementById('studentSearchBox').oninput = (e) => {
  const searchTerm = e.target.value.toLowerCase();
  
  if (searchTerm === '') {
    filteredStudents = [...allStudents];
  } else {
    filteredStudents = allStudents.filter(student => 
      student.name.toLowerCase().includes(searchTerm) || 
      student.id.toLowerCase().includes(searchTerm)
    );
  }
  
  renderStudentList();
};

// FERPA-Compliant Session Upload
document.getElementById('sessionRosterForm').onsubmit = async (e) => {
  e.preventDefault();
  console.log('Session roster form submitted');
  
  const fileInput = e.target.querySelector('input[type="file"]');
  const resultDiv = document.getElementById('sessionRosterResult');
  
  if (!fileInput.files || fileInput.files.length === 0) {
    resultDiv.innerHTML = `<p style="color: #d32f2f; margin: 5px 0 0 0;">❌ Please select a CSV file</p>`;
    return;
  }
  
  resultDiv.innerHTML = `<p style="color: #2196f3; margin: 5px 0 0 0;">📤 Uploading...</p>`;
  
  try {
    const fd = new FormData(e.target);
    console.log('Sending request to /api/upload_session_roster');
    const r = await fetch('/api/upload_session_roster', {method:'POST', body: fd});
    console.log('Response status:', r.status);
    const j = await r.json();
    console.log('session_roster_upload response:', j);
    
    if (j.ok) {
      resultDiv.innerHTML = `<p style="color: #2e7d32; margin: 5px 0 0 0;">✅ ${j.imported} students loaded to session (FERPA compliant)</p>`;
      setTimeout(() => location.reload(), 1500); // Refresh to show updated count
    } else {
      resultDiv.innerHTML = `<p style="color: #d32f2f; margin: 5px 0 0 0;">❌ ${j.message || 'Upload failed'}</p>`;
    }
  } catch (error) {
    console.error('Upload error:', error);
    resultDiv.innerHTML = `<p style="color: #d32f2f; margin: 5px 0 0 0;">❌ Network error: ${error.message}</p>`;
  }
};



// Alternative button handlers (in case form submission doesn't work)
document.addEventListener('DOMContentLoaded', function() {
  // Session roster alternative upload
  const sessionUploadBtn = document.getElementById('sessionUploadBtn');
  if (sessionUploadBtn) {
    sessionUploadBtn.onclick = async () => {
      console.log('Session alternative button clicked');
      const fileInput = document.getElementById('sessionFileInput');
      const resultDiv = document.getElementById('sessionRosterResult');
      
      if (!fileInput.files || fileInput.files.length === 0) {
        resultDiv.innerHTML = `<p style="color: #d32f2f; margin: 5px 0 0 0;">❌ Please select a CSV file first</p>`;
        return;
      }
      
      resultDiv.innerHTML = `<p style="color: #2196f3; margin: 5px 0 0 0;">📤 Uploading via alternative method...</p>`;
      
      try {
        const fd = new FormData();
        fd.append('file', fileInput.files[0]);
        console.log('Sending alternative request to /api/upload_session_roster');
        const r = await fetch('/api/upload_session_roster', {method:'POST', body: fd});
        console.log('Alternative response status:', r.status);
        const j = await r.json();
        console.log('Alternative session_roster_upload response:', j);
        
        if (j.ok) {
          resultDiv.innerHTML = `<p style="color: #2e7d32; margin: 5px 0 0 0;">✅ ${j.imported} students loaded to session (FERPA compliant)</p>`;
          setTimeout(() => location.reload(), 1500);
        } else {
          resultDiv.innerHTML = `<p style="color: #d32f2f; margin: 5px 0 0 0;">❌ ${j.message || 'Upload failed'}</p>`;
        }
      } catch (error) {
        console.error('Alternative upload error:', error);
        resultDiv.innerHTML = `<p style="color: #d32f2f; margin: 5px 0 0 0;">❌ Network error: ${error.message}</p>`;
      }
    };
  }
  

  

  
  // Test authentication button
  const testAuthBtn = document.getElementById('testAuthBtn');
  if (testAuthBtn) {
    testAuthBtn.onclick = async () => {
      console.log('Testing authentication...');
      const resultDiv = document.getElementById('testAuthResult');
      resultDiv.textContent = 'Testing...';
      
      try {
        const r = await fetch('/api/test_auth', {method:'POST'});
        console.log('Test auth response status:', r.status);
        const j = await r.json();
        console.log('Test auth response:', j);
        
        if (j.ok) {
          resultDiv.style.color = '#2e7d32';
          resultDiv.textContent = '✅ Authentication working';
        } else {
          resultDiv.style.color = '#d32f2f';
          resultDiv.textContent = `❌ Auth failed: ${j.message}`;
        }
      } catch (error) {
        console.error('Test auth error:', error);
        resultDiv.style.color = '#d32f2f';
        resultDiv.textContent = `❌ Error: ${error.message}`;
      }
    };
  }
  
  // View session roster button
  const viewSessionBtn = document.getElementById('viewSessionBtn');
  if (viewSessionBtn) {
    viewSessionBtn.onclick = async () => {
      console.log('Viewing session roster...');
      const resultDiv = document.getElementById('sessionDebugResult');
      resultDiv.textContent = 'Loading...';
      
      try {
        const r = await fetch('/api/session_roster');
        console.log('Session roster response status:', r.status);
        const j = await r.json();
        console.log('Session roster response:', j);
        
        if (j.ok) {
          resultDiv.style.color = '#2e7d32';
          const rosterEntries = Object.entries(j.roster);
          if (rosterEntries.length === 0) {
            resultDiv.innerHTML = '📝 Session roster is empty';
          } else {
            resultDiv.innerHTML = `📝 Session roster (${j.count} students):<br/>` + 
              rosterEntries.slice(0, 10).map(([id, name]) => `${id}: ${name}`).join('<br/>') +
              (rosterEntries.length > 10 ? `<br/>... and ${rosterEntries.length - 10} more` : '');
          }
        } else {
          resultDiv.style.color = '#d32f2f';
          resultDiv.textContent = `❌ Failed: ${j.message}`;
        }
      } catch (error) {
        console.error('View session error:', error);
        resultDiv.style.color = '#d32f2f';
        resultDiv.textContent = `❌ Error: ${error.message}`;
      }
    };
  }
  
  // Clear session roster button
  const clearSessionBtn = document.getElementById('clearSessionBtn');
  if (clearSessionBtn) {
    clearSessionBtn.onclick = async () => {
      if (!confirm('Clear the session roster? This will remove all uploaded student data from your session.')) {
        return;
      }
      
      console.log('Clearing session roster...');
      const resultDiv = document.getElementById('sessionDebugResult');
      resultDiv.textContent = 'Clearing...';
      
      try {
        const r = await fetch('/api/clear_session_roster', {method:'POST'});
        console.log('Clear session response status:', r.status);
        const j = await r.json();
        console.log('Clear session response:', j);
        
        if (j.ok) {
          resultDiv.style.color = '#2e7d32';
          resultDiv.textContent = '✅ Session roster cleared';
          setTimeout(() => location.reload(), 1000);
        } else {
          resultDiv.style.color = '#d32f2f';
          resultDiv.textContent = `❌ Failed: ${j.message}`;
        }
      } catch (error) {
        console.error('Clear session error:', error);
        resultDiv.style.color = '#d32f2f';
        resultDiv.textContent = `❌ Error: ${error.message}`;
      }
    };
  }
});

document.getElementById('settingsForm').onsubmit = async (e) => {
  e.preventDefault();
  const f = e.target;
  const payload = {
    room_name: f.room_name.value,
    capacity: Number(f.capacity.value),
    overdue_minutes: Number(f.overdue_minutes.value)
  };
  const r = await fetch('/api/settings', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)});
  const j = await r.json();
  console.log('settings_update', j);
  document.getElementById('settingsResult').textContent = j.ok ? 'Saved.' : (j.message || 'Error');
};

// Suspend/Resume kiosk handlers
const suspendBtn = document.getElementById('suspendKiosk');
const resumeBtn = document.getElementById('resumeKiosk');

if (suspendBtn) {
  suspendBtn.onclick = async () => {
    if (confirm('Are you sure you want to suspend the kiosk? Students will not be able to scan in/out.')) {
      try{
        const r = await fetch('/api/suspend_kiosk', {method:'POST'});
        const j = await r.json();
        console.log('suspend', j);
        if (j.ok) {
          location.reload();
        } else {
          alert(j.message || 'Error suspending kiosk');
        }
      }catch(e){
        console.error('suspend error', e);
        alert('Error suspending kiosk');
      }
    }
  };
}

if (resumeBtn) {
  resumeBtn.onclick = async () => {
    try{
      const r = await fetch('/api/resume_kiosk', {method:'POST'});
      const j = await r.json();
      console.log('resume', j);
      if (j.ok) {
        location.reload();
      } else {
        alert(j.message || 'Error resuming kiosk');
      }
    }catch(e){
      console.error('resume error', e);
      alert('Error resuming kiosk');
    }
  };
}

const migrateBtn = document.getElementById('runMigration');
if (migrateBtn) {
  migrateBtn.onclick = async () => {
    if (!confirm('Run database migration now?')) return;
    migrateBtn.disabled = true;
    document.getElementById('migrationResult').textContent = 'Running...';
    try {
      const r = await fetch('/api/migrate', {method:'POST'});
      const j = await r.json();
      console.log('migrate', j);
      if (j.ok) {
        document.getElementById('migrationResult').textContent = 'Migration completed.';
        setTimeout(()=>location.reload(), 1000);
      } else {
        document.getElementById('migrationResult').textContent = j.message || 'Migration failed';
      }
    } catch (e) {
      console.error('migration error', e);
      document.getElementById('migrationResult').textContent = 'Migration failed';
    } finally {
      migrateBtn.disabled = false;
    }
  };
}

// Hard reset database (danger zone)
const resetDbBtn = document.getElementById('resetDbBtn');
if (resetDbBtn) {
  resetDbBtn.onclick = async () => {
    if (!confirm('This will permanently DELETE all session history from the database. Continue?')) return;
    if (!confirm('Are you absolutely sure? This cannot be undone.')) return;
    resetDbBtn.disabled = true;
    const result = document.getElementById('resetDbResult');
    result.textContent = 'Resetting...';
    try{
      const r = await fetch('/api/reset_database', {method:'POST'});
      const j = await r.json();
      if (j.ok) {
        result.textContent = `Done. Removed ${j.cleared_sessions} sessions.`;
        setTimeout(()=>location.reload(), 1200);
      } else {
        result.textContent = j.message || 'Reset failed';
      }
    }catch(e){
      result.textContent = 'Network error';
    } finally {
      resetDbBtn.disabled = false;
    }
  };
}
</script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
async function loadCharts(){
  try{
    const r = await fetch('/api/stats/week');
    const j = await r.json();
    const c1 = document.getElementById('chartTopUsage');
    const c2 = document.getElementById('chartTopOverdue');
    const c3 = document.getElementById('chartTopOverdueRate');
    new Chart(c1, {type:'bar', data:{labels:j.top_usage.labels, datasets:[{label:'Count', data:j.top_usage.values, backgroundColor:'rgba(41,183,101,0.6)'}]}, options:{plugins:{legend:{display:false}}, indexAxis:'y'}});
    new Chart(c2, {type:'bar', data:{labels:j.top_overdue.labels, datasets:[{label:'Overdues', data:j.top_overdue.overdues, backgroundColor:'rgba(242, 201, 76, 0.7)'}]}, options:{plugins:{legend:{display:false}}, indexAxis:'y'}});
    new Chart(c3, {type:'bar', data:{labels:j.top_overdue_rate.labels, datasets:[{label:'Overdue %', data:j.top_overdue_rate.rates, backgroundColor:'rgba(217, 83, 79, 0.7)'}]}, options:{plugins:{legend:{display:false}}, indexAxis:'y'}});
  }catch(e){}
}
loadCharts();
</script>
{% endblock %}
